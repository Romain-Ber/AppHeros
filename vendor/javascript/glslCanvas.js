import e from"xhr";var t="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"===typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};(function(){function AwaitValue(e){this.value=e}function AsyncGenerator(e){var t,r;function send(e,i){return new Promise((function(a,n){var s={key:e,arg:i,resolve:a,reject:n,next:null};if(r)r=r.next=s;else{t=r=s;resume(e,i)}}))}function resume(t,r){try{var i=e[t](r);var a=i.value;a instanceof AwaitValue?Promise.resolve(a.value).then((function(e){resume("next",e)}),(function(e){resume("throw",e)})):settle(i.done?"return":"normal",i.value)}catch(e){settle("throw",e)}}function settle(e,i){switch(e){case"return":t.resolve({value:i,done:true});break;case"throw":t.reject(i);break;default:t.resolve({value:i,done:false});break}t=t.next;t?resume(t.key,t.arg):r=null}this._invoke=send;"function"!==typeof e.return&&(this.return=void 0)}"function"===typeof Symbol&&Symbol.asyncIterator&&(AsyncGenerator.prototype[Symbol.asyncIterator]=function(){return this});AsyncGenerator.prototype.next=function(e){return this._invoke("next",e)};AsyncGenerator.prototype.throw=function(e){return this._invoke("throw",e)};AsyncGenerator.prototype.return=function(e){return this._invoke("return",e)}})();var classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")};var r=function(){function defineProperties(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||false;i.configurable=true;"value"in i&&(i.writable=true);Object.defineProperty(e,i.key,i)}}return function(e,t,r){t&&defineProperties(e.prototype,t);r&&defineProperties(e,r);return e}}();var toConsumableArray=function(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)};var i="";
/**
 * Creates the HTLM for a failure message
 * @param {string} canvasContainerId id of container of th
 *        canvas.
 * @return {string} The html.
 */function makeFailHTML(e){return'\n<table style="background-color: #8CE; width: 100%; height: 100%;"><tr>\n<td align="center">\n<div style="display: table-cell; vertical-align: middle;">\n<div style="">'+e+"</div>\n</div>\n</td></tr></table>\n"}
/**
 * Message for getting a webgl browser
 * @type {string}
 */var a='\n\tThis page requires a browser that supports WebGL.<br/>\n\t<a href="http://get.webgl.org">Click here to upgrade your browser.</a>\n';
/**
 * Message for need better hardware
 * @type {string}
 */var n='\n\tIt does not appear your computer can support WebGL.<br/>\n\t<a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>\n';
/**
 * Code to return in `onError` callback when the browser doesn't support webgl
 * @type {number}
 */var s=1;
/**
 * Code to return in `onError` callback there's any other problem related to webgl
 * @type {number}
 */var o=2;
/**
 * Creates a webgl context. If creation fails it will
 * change the contents of the container of the <canvas>
 * tag to an error message with the correct links for WebGL,
 * unless `onError` option is defined to a callback,
 * which allows for custom error handling..
 * @param {Element} canvas. The canvas element to create a
 *     context from.
 * @param {WebGLContextCreationAttributes} optAttribs Any
 *     creation attributes you want to pass in.
 * @return {WebGLRenderingContext} The created context.
 */function setupWebGL(e,t,r){function showLink(t){var r=e.parentNode;r&&(r.innerHTML=makeFailHTML(t))}function handleError(e,t){"function"===typeof r?r(e):showLink(t)}if(!window.WebGLRenderingContext){handleError(s,a);return null}var i=create3DContext(e,t);i?i.getExtension("OES_standard_derivatives"):handleError(o,n);return i}
/**
 * Creates a webgl context.
 * @param {!Canvas} canvas The canvas tag to get context
 *     from. If one is not passed in one will be created.
 * @return {!WebGLContext} The created context.
 */function create3DContext(e,t){var r=["webgl","experimental-webgl"];var i=null;for(var a=0;a<r.length;++a)try{i=e.getContext(r[a],t)}catch(e){if(i)break}return i}function createShader(e,t,r,a){var n=e.gl;var s=n.createShader(r);n.shaderSource(s,t);n.compileShader(s);var o=n.getShaderParameter(s,n.COMPILE_STATUS);if(!o){i=n.getShaderInfoLog(s);console.error("*** Error compiling shader "+s+":"+i);e.trigger("error",{shader:s,source:t,type:r,error:i,offset:a||0});n.deleteShader(s);return null}return s}
/**
 * Loads a shader.
 * @param {!WebGLContext} gl The WebGLContext to use.
 * @param {string} shaderSource The shader source.
 * @param {number} shaderType The type of shader.
 * @param {function(string): void) opt_errorCallback callback for errors.
 * @return {!WebGLShader} The created shader.
 */function createProgram(e,t,r,a){var n=e.gl;var s=n.createProgram();for(var o=0;o<t.length;++o)n.attachShader(s,t[o]);if(r)for(var l=0;l<r.length;++l)n.bindAttribLocation(s,a?a[l]:l,r[l]);n.linkProgram(s);var u=n.getProgramParameter(s,n.LINK_STATUS);if(!u){i=n.getProgramInfoLog(s);console.log("Error in program linking:"+i);n.deleteProgram(s);return null}return s}function parseUniforms(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;var i=[];for(var a in e){var n=e[a];var s=void 0;r&&(a=r+"."+a);if("number"===typeof n)i.push({type:"float",method:"1f",name:a,value:n});else if(Array.isArray(n)){if("number"===typeof n[0])1===n.length?i.push({type:"float",method:"1f",name:a,value:n}):n.length>=2&&n.length<=4?i.push({type:"vec"+n.length,method:n.length+"fv",name:a,value:n}):n.length>4&&i.push({type:"float[]",method:"1fv",name:a+"[0]",value:n});else if("string"===typeof n[0])i.push({type:"sampler2D",method:"1i",name:a,value:n});else if(Array.isArray(n[0])&&"number"===typeof n[0][0]){if(n[0].length>=2&&n[0].length<=4)for(s=0;s<n.length;s++)i.push({type:"vec"+n[0].length,method:n[s].length+"fv",name:a+"["+s+"]",value:n[s]})}else if("object"===t(n[0]))for(s=0;s<n.length;s++)i.push.apply(i,toConsumableArray(parseUniforms(n[s],a+"["+s+"]")))}else"boolean"===typeof n?i.push({type:"bool",method:"1i",name:a,value:n}):"string"===typeof n?i.push({type:"sampler2D",method:"1i",name:a,value:n}):"object"===("undefined"===typeof n?"undefined":t(n))&&i.push.apply(i,toConsumableArray(parseUniforms(n,a)))}return i}function isCanvasVisible(e){var t=e.getBoundingClientRect();return t.top+t.height>0&&t.top<(window.innerHeight||document.documentElement.clientHeight)}function isPowerOf2(e){return 0===(e&e-1)}function isSafari(){return/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}function isDiff(e,t){return!(!e||!t)&&e.toString()!==t.toString()}function getFile(e){var t=new XMLHttpRequest;t.open("GET",e,false);t.send();return 200==t.status?t.responseText:""}function subscribeMixin$1(e){var t=new Set;return Object.assign(e,{on:function on(e,r){var i={};i[e]=r;t.add(i)},off:function off(e,r){if(r){var i={};i[e]=r;t.delete(i)}else{var a=true;var n=false;var s=void 0;try{for(var o,l=t[Symbol.iterator]();!(a=(o=l.next()).done);a=true){var u=o.value;var h=true;var f=false;var g=void 0;try{for(var d,v=Object.keys(u)[Symbol.iterator]();!(h=(d=v.next()).done);h=true){var c=d.value;if(c===e){t.delete(u);return}}}catch(e){f=true;g=e}finally{try{!h&&v.return&&v.return()}finally{if(f)throw g}}}}catch(e){n=true;s=e}finally{try{!a&&l.return&&l.return()}finally{if(n)throw s}}}},listSubscriptions:function listSubscriptions(){var e=true;var r=false;var i=void 0;try{for(var a,n=t[Symbol.iterator]();!(e=(a=n.next()).done);e=true){var s=a.value;console.log(s)}}catch(e){r=true;i=e}finally{try{!e&&n.return&&n.return()}finally{if(r)throw i}}},subscribe:function subscribe(e){t.add(e)},unsubscribe:function unsubscribe(e){t.delete(e)},unsubscribeAll:function unsubscribeAll(){t.clear()},trigger:function trigger(e){for(var r=arguments.length,i=Array(r>1?r-1:0),a=1;a<r;a++)i[a-1]=arguments[a];var n=true;var s=false;var o=void 0;try{for(var l,u=t[Symbol.iterator]();!(n=(l=u.next()).done);n=true){var h=l.value;"function"===typeof h[e]&&h[e].apply(h,toConsumableArray(i))}}catch(e){s=true;o=e}finally{try{!n&&u.return&&u.return()}finally{if(s)throw o}}}})}var l=function(){function Texture(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};classCallCheck(this,Texture);subscribeMixin$1(this);this.gl=e;this.texture=e.createTexture();this.texture&&(this.valid=true);this.bind();this.name=t;this.source=null;this.sourceType=null;this.loading=null;this.setData(1,1,new Uint8Array([0,0,0,255]),{filtering:"linear"});this.setFiltering(r.filtering);this.load(r)}r(Texture,[{key:"destroy",value:function destroy(){if(this.valid){this.gl.deleteTexture(this.texture);this.texture=null;delete this.data;this.data=null;this.valid=false}}},{key:"bind",value:function bind(e){if(this.valid){if("number"===typeof e&&Texture.activeUnit!==e){this.gl.activeTexture(this.gl.TEXTURE0+e);Texture.activeUnit=e}if(Texture.activeTexture!==this.texture){this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture);Texture.activeTexture=this.texture}}}},{key:"load",value:function load(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.loading=null;"string"===typeof e.url?void 0!==this.url&&e.url===this.url||this.setUrl(e.url,e):e.element?this.setElement(e.element,e):e.data&&e.width&&e.height&&this.setData(e.width,e.height,e.data,e)}},{key:"setUrl",value:function setUrl(e){var t=this;var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.valid){this.url=e;this.source=this.url;this.sourceType="url";this.loading=new Promise((function(i,a){var n=e.split(".").pop().toLowerCase();var s="ogv"===n||"webm"===n||"mp4"===n;var o=void 0;if(s){o=document.createElement("video");o.autoplay=true;o.muted=true;setTimeout((function(){o.play()}),1);r.filtering="nearest"}else o=new Image;o.onload=function(){try{t.setElement(o,r)}catch(e){console.log("Texture '"+t.name+"': failed to load url: '"+t.source+"'",e,r)}i(t)};o.onerror=function(e){console.log("Texture '"+t.name+"': failed to load url: '"+t.source+"'",e,r);i(t)};isSafari()&&"data:"===t.source.slice(0,5)||(o.crossOrigin="anonymous");o.src=t.source;s&&t.setElement(o,r)}));return this.loading}}},{key:"setData",value:function setData(e,t,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};this.width=e;this.height=t;this.source=r;this.sourceType="data";this.update(i);this.setFiltering(i);this.loading=Promise.resolve(this);return this.loading}},{key:"setElement",value:function setElement(e,t){var r=this;var i=e;"string"===typeof e&&(e=document.querySelector(e));if(e instanceof HTMLCanvasElement||e instanceof HTMLImageElement||e instanceof HTMLVideoElement){this.source=e;this.sourceType="element";if(e instanceof HTMLVideoElement){this.width=this.source.videoWidth;this.height=this.source.videoHeight;e.addEventListener("canplaythrough",(function(){r.intervalID=setInterval((function(){r.update(t)}),15)}),true);e.addEventListener("ended",(function(){e.currentTime=0;e.play()}),true)}else this.update(t);this.setFiltering(t)}else{var a="the 'element' parameter (`element: "+JSON.stringify(i)+"`) must be a CSS ";a+="selector string, or a <canvas>, <image> or <video> object";console.log("Texture '"+this.name+"': "+a,t)}this.loading=Promise.resolve(this);return this.loading}},{key:"update",value:function update(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this.valid){this.bind();this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,false!==e.UNPACK_FLIP_Y_WEBGL);this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e.UNPACK_PREMULTIPLY_ALPHA_WEBGL||false);if("element"===this.sourceType&&(this.source instanceof HTMLCanvasElement||this.source instanceof HTMLVideoElement||this.source instanceof HTMLImageElement&&this.source.complete)){if(this.source instanceof HTMLVideoElement){this.width=this.source.videoWidth;this.height=this.source.videoHeight}else{this.width=this.source.width;this.height=this.source.height}this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.source)}else"data"===this.sourceType&&this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.width,this.height,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.source);this.trigger("loaded",this)}}},{key:"setFiltering",value:function setFiltering(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this.valid){this.powerOf2=isPowerOf2(this.width)&&isPowerOf2(this.height);this.filtering=e.filtering||"linear";var t=this.gl;this.bind();if(this.powerOf2){t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,e.TEXTURE_WRAP_S||t.REPEAT);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,e.TEXTURE_WRAP_T||t.REPEAT);if("mipmap"===this.filtering){t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR);t.generateMipmap(t.TEXTURE_2D)}else if("linear"===this.filtering){t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR)}else if("nearest"===this.filtering){t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST)}}else{t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);"mipmap"===this.filtering&&(this.filtering="linear");if("nearest"===this.filtering){t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST)}else{t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR)}}}}}]);return Texture}();l.getMaxTextureSize=function(e){return e.getParameter(e.MAX_TEXTURE_SIZE)};l.activeUnit=-1;var u=function(){function GlslCanvas(t,r,i){var a=this;classCallCheck(this,GlslCanvas);subscribeMixin$1(this);r=r||{};i=i||{};if(!t.hasAttribute("data-fullscreen")||"1"!=t.getAttribute("data-fullscreen")&&"true"!=t.getAttribute("data-fullscreen")){this.width=t.clientWidth;this.height=t.clientHeight}else{this.width=window.innerWidth;this.height=window.innerHeight;t.width=window.innerWidth;t.height=window.innerHeight}this.canvas=t;this.gl=void 0;this.deps={};this.program=void 0;this.textures={};this.buffers={};this.uniforms={};this.vbo={};this.isValid=false;this.animationFrameRequest=void 0;this.BUFFER_COUNT=0;this.vertexString=r.vertexString||"\n#ifdef GL_ES\nprecision mediump float;\n#endif\n\nattribute vec2 a_position;\nattribute vec2 a_texcoord;\n\nvarying vec2 v_texcoord;\n\nvoid main() {\n    gl_Position = vec4(a_position, 0.0, 1.0);\n    v_texcoord = a_texcoord;\n}\n";this.fragmentString=r.fragmentString||"\n#ifdef GL_ES\nprecision mediump float;\n#endif\n\nvarying vec2 v_texcoord;\n\nvoid main(){\n    gl_FragColor = vec4(0.0);\n}\n";var n=setupWebGL(t,r,i.onError);if(n){this.gl=n;this.timeLoad=this.timePrev=performance.now();this.timeDelta=0;this.forceRender=true;this.paused=false;this.realToCSSPixels=window.devicePixelRatio||1;t.style.backgroundColor=r.backgroundColor||"rgba(1,1,1,0)";if(t.hasAttribute("data-fragment"))this.fragmentString=t.getAttribute("data-fragment");else if(t.hasAttribute("data-fragment-url")){var s=t.getAttribute("data-fragment-url");e.get(s,(function(e,t,r){a.load(r,a.vertexString)}))}if(t.hasAttribute("data-vertex"))this.vertexString=t.getAttribute("data-vertex");else if(t.hasAttribute("data-vertex-url")){var o=t.getAttribute("data-vertex-url");e.get(o,(function(e,t,r){a.load(a.fragmentString,r)}))}this.load();if(this.program){var l=n.getAttribLocation(this.program,"a_texcoord");this.vbo.texCoords=n.createBuffer();this.gl.bindBuffer(n.ARRAY_BUFFER,this.vbo.texCoords);this.gl.bufferData(n.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),n.STATIC_DRAW);this.gl.enableVertexAttribArray(l);this.gl.vertexAttribPointer(l,2,n.FLOAT,false,0,0);var u=n.getAttribLocation(this.program,"a_position");this.vbo.vertices=n.createBuffer();this.gl.bindBuffer(n.ARRAY_BUFFER,this.vbo.vertices);this.gl.bufferData(n.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),n.STATIC_DRAW);this.gl.enableVertexAttribArray(u);this.gl.vertexAttribPointer(u,2,n.FLOAT,false,0,0);if(t.hasAttribute("data-textures")){var h=t.getAttribute("data-textures").split(",");for(var f in h)this.setUniform("u_tex"+f,h[f])}var g={x:0,y:0};document.addEventListener("mousemove",(function(e){g.x=e.clientX||e.pageX;g.y=e.clientY||e.pageY}),false);var d=this;this.setMouse({x:0,y:0});RenderLoop();return this}}function RenderLoop(){d.nMouse>1&&d.setMouse(g);d.resize()&&(d.forceRender=true);d.render();d.animationFrameRequest=window.requestAnimationFrame(RenderLoop)}}r(GlslCanvas,[{key:"destroy",value:function destroy(){cancelAnimationFrame(this.animationFrameRequest);this.animated=false;this.isValid=false;for(var e in this.textures)e.destroy&&e.destroy();this.textures={};for(var t in this.attribs)this.gl.deleteBuffer(this.attribs[t]);this.gl.useProgram(null);this.gl.deleteProgram(this.program);for(var r in this.buffers){var i=this.buffers[r];this.gl.deleteProgram(i.program)}this.program=null;this.gl=null}},{key:"load",value:function load(e,t){var r=this;t&&(this.vertexString=t);e&&(this.fragmentString=e);var i=this.fragmentString.split(/\r?\n/);this.fragmentString="#define PLATFORM_WEBGL\n#line 0\n";i.forEach((function(e,t){var i=e.trim();if(i.startsWith('#include "lygia')){var a=i.substring(15).replace(/\'|\"|\;|\s/g,"");if(a.endsWith("glsl")){if(void 0===r.deps[a]){var n="https://lygia.xyz"+a;r.deps[a]=getFile(n)}r.fragmentString+=r.deps[a]+"\n#line "+(t+1)+"\n"}}else r.fragmentString+=e+"\n"}));this.animated=false;this.nDelta=(this.fragmentString.match(/u_delta/g)||[]).length;this.nTime=(this.fragmentString.match(/u_time/g)||[]).length;this.nDate=(this.fragmentString.match(/u_date/g)||[]).length;this.nMouse=(this.fragmentString.match(/u_mouse/g)||[]).length;this.animated=this.nDate>1||this.nTime>1||this.nMouse>1;var a=this.fragmentString.search(/sampler2D/g);if(a){var n=this.fragmentString.split("\n");for(var s=0;s<n.length;s++){var o=n[s].match(/uniform\s*sampler2D\s*([\w]*);\s*\/\/\s*([\w|\:\/\/|\.|\-|\_]*)/i);if(o){var l=o[2].split(".").pop().toLowerCase();o[1]&&o[2]&&("jpg"===l||"jpeg"===l||"png"===l||"ogv"===l||"webm"===l||"mp4"===l)&&this.setUniform(o[1],o[2])}var u=n[s].match(/\s*void\s*main\s*/g);if(u)break}}var h=createShader(this,this.vertexString,this.gl.VERTEX_SHADER);var f=createShader(this,this.fragmentString,this.gl.FRAGMENT_SHADER);if(f)this.isValid=true;else{f=createShader(this,"void main(){\n\tgl_FragColor = vec4(1.0);\n}",this.gl.FRAGMENT_SHADER);this.isValid=false}var g=createProgram(this,[h,f]);this.gl.useProgram(g);this.gl.deleteShader(h);this.gl.deleteShader(f);this.program=g;this.change=true;this.BUFFER_COUNT=0;var d=this.getBuffers(this.fragmentString);Object.keys(d).length&&this.loadPrograms(d);this.buffers=d;this.texureIndex=this.BUFFER_COUNT;this.trigger("load",{});this.forceRender=true;this.render()}},{key:"test",value:function test(e,t,r){var i=this.vertexString;var a=this.fragmentString;var n=this.paused;var s=this.gl.getExtension("EXT_disjoint_timer_query");var o=s.createQueryEXT();var l=this.isValid;if(t||r){this.load(t,r);l=this.isValid;this.forceRender=true;this.render()}this.paused=true;s.beginQueryEXT(s.TIME_ELAPSED_EXT,o);this.forceRender=true;this.render();s.endQueryEXT(s.TIME_ELAPSED_EXT);var u=this;function finishTest(){u.paused=n;(t||r)&&u.load(a,i)}function waitForTest(){u.forceRender=true;u.render();var i=s.getQueryObjectEXT(o,s.QUERY_RESULT_AVAILABLE_EXT);var a=u.gl.getParameter(s.GPU_DISJOINT_EXT);if(i&&!a){var n={wasValid:l,frag:t||u.fragmentString,vert:r||u.vertexString,timeElapsedMs:s.getQueryObjectEXT(o,s.QUERY_RESULT_EXT)/1e6};finishTest();e(n)}else window.requestAnimationFrame(waitForTest)}waitForTest()}},{key:"loadTexture",value:function loadTexture(e,r,i){var a=this;i||(i={});if("string"===typeof r)i.url=r;else if("object"===("undefined"===typeof r?"undefined":t(r))&&r.data&&r.width&&r.height){i.data=r.data;i.width=r.width;i.height=r.height}else"object"===("undefined"===typeof r?"undefined":t(r))&&(i.element=r);if(this.textures[e]){if(this.textures[e]){this.textures[e].load(i);this.textures[e].on("loaded",(function(e){a.forceRender=true}))}}else{this.textures[e]=new l(this.gl,e,i);this.textures[e].on("loaded",(function(e){a.forceRender=true}))}}},{key:"refreshUniforms",value:function refreshUniforms(){this.uniforms={}}},{key:"setUniform",value:function setUniform(e){var t={};for(var r=arguments.length,i=Array(r>1?r-1:0),a=1;a<r;a++)i[a-1]=arguments[a];t[e]=i;this.setUniforms(t)}},{key:"setUniforms",value:function setUniforms(e){var t=parseUniforms(e);for(var r in t)"sampler2D"===t[r].type?this.loadTexture(t[r].name,t[r].value[0]):this.uniform(t[r].method,t[r].type,t[r].name,t[r].value);this.forceRender=true}},{key:"setMouse",value:function setMouse(e){var t=this.canvas.getBoundingClientRect();if(e&&e.x&&e.x>=t.left&&e.x<=t.right&&e.y&&e.y>=t.top&&e.y<=t.bottom){var r=(e.x-t.left)*this.realToCSSPixels;var i=this.canvas.height-(e.y-t.top)*this.realToCSSPixels;this.uniform("2f","vec2","u_mouse",r,i)}}},{key:"uniform",value:function uniform(e,t,r){this.uniforms[r]=this.uniforms[r]||{};var uniform=this.uniforms[r];for(var i=arguments.length,a=Array(i>3?i-3:0),n=3;n<i;n++)a[n-3]=arguments[n];var s=isDiff(uniform.value,a);if(s||this.change||!uniform.location||!uniform.value){uniform.name=r;uniform.type=t;uniform.value=a;uniform.method="uniform"+e;this.gl.useProgram(this.program);uniform.location=this.gl.getUniformLocation(this.program,r);this.gl[uniform.method].apply(this.gl,[uniform.location].concat(uniform.value));for(var o in this.buffers){var l=this.buffers[o];this.gl.useProgram(l.program);var u=this.gl.getUniformLocation(l.program,r);this.gl[uniform.method].apply(this.gl,[u].concat(uniform.value))}}}},{key:"uniformTexture",value:function uniformTexture(e,t,r){if(void 0===this.textures[e])this.loadTexture(e,t,r);else{this.uniform("1i","sampler2D",e,this.texureIndex);for(var i in this.buffers){var a=this.buffers[i];this.gl.useProgram(a.program);this.gl.activeTexture(this.gl.TEXTURE0+this.texureIndex);this.gl.bindTexture(this.gl.TEXTURE_2D,this.textures[e].texture)}this.gl.useProgram(this.program);this.gl.activeTexture(this.gl.TEXTURE0+this.texureIndex);this.gl.bindTexture(this.gl.TEXTURE_2D,this.textures[e].texture);this.uniform("2f","vec2",e+"Resolution",this.textures[e].width,this.textures[e].height)}}},{key:"resize",value:function resize(){if(this.width!==this.canvas.clientWidth||this.height!==this.canvas.clientHeight){this.realToCSSPixels=window.devicePixelRatio||1;var e=Math.floor(this.gl.canvas.clientWidth*this.realToCSSPixels);var t=Math.floor(this.gl.canvas.clientHeight*this.realToCSSPixels);if(this.gl.canvas.width!==e||this.gl.canvas.height!==t){this.gl.canvas.width=e;this.gl.canvas.height=t;this.gl.viewport(0,0,this.gl.canvas.width,this.gl.canvas.height)}this.width=this.canvas.clientWidth;this.height=this.canvas.clientHeight;this.resizeSwappableBuffers();return true}return false}},{key:"render",value:function render(){this.visible=isCanvasVisible(this.canvas);if(this.forceRender||this.change||this.animated&&this.visible&&!this.paused){var e=new Date;var t=performance.now();this.timeDelta=(t-this.timePrev)/1e3;this.timePrev=t;this.nDelta>1&&this.uniform("1f","float","u_delta",this.timeDelta);this.nTime>1&&this.uniform("1f","float","u_time",(t-this.timeLoad)/1e3);this.nDate&&this.uniform("4f","float","u_date",e.getFullYear(),e.getMonth(),e.getDate(),3600*e.getHours()+60*e.getMinutes()+e.getSeconds()+.001*e.getMilliseconds());this.uniform("2f","vec2","u_resolution",this.canvas.width,this.canvas.height);for(var r in this.buffers){var i=this.buffers[r];this.uniform("1i","sampler2D",i.name,i.bundle.input.index)}this.texureIndex=this.BUFFER_COUNT;for(var a in this.textures){this.uniformTexture(a);this.texureIndex++}this.renderPrograms();this.trigger("render",{});this.change=false;this.forceRender=false}}},{key:"pause",value:function pause(){this.paused=true}},{key:"play",value:function play(){this.paused=false}},{key:"renderPrograms",value:function renderPrograms(){var e=this.gl;var t=e.canvas.width;var r=e.canvas.height;e.viewport(0,0,t,r);for(var i in this.buffers){var a=this.buffers[i];a.bundle.render(t,r,a.program,a.name);e.bindFramebuffer(e.FRAMEBUFFER,null)}e.useProgram(this.program);e.drawArrays(e.TRIANGLES,0,6)}},{key:"getBuffers",value:function getBuffers(e){var t={};e&&e.replace(/(?:^\s*)((?:#if|#elif)(?:\s*)(defined\s*\(\s*BUFFER_)(\d+)(?:\s*\))|(?:#ifdef)(?:\s*BUFFER_)(\d+)(?:\s*))/gm,(function(){var r=arguments[3]||arguments[4];t["u_buffer"+r]={fragment:"#define BUFFER_"+r+"\n"+e}}));return t}},{key:"loadPrograms",value:function loadPrograms(e){var t=this;var r=this.gl;var i=createShader(t,t.vertexString,r.VERTEX_SHADER);for(var a in e){var n=e[a];var s=createShader(t,n.fragment,r.FRAGMENT_SHADER,1);if(s)t.isValid=true;else{s=createShader(t,"void main(){\n\tgl_FragColor = vec4(1.0);\n}",r.FRAGMENT_SHADER);t.isValid=false}var o=createProgram(t,[i,s]);n.name=a;n.program=o;n.bundle=t.createSwappableBuffer(t.canvas.width,t.canvas.height,o);r.deleteShader(s)}r.deleteShader(i)}},{key:"createSwappableBuffer",value:function createSwappableBuffer(e,t,r){var i=this.createBuffer(e,t,r);var a=this.createBuffer(e,t,r);var n=this.gl;return{input:i,output:a,swap:function swap(){var e=i;i=a;a=e;this.input=i;this.output=a},render:function render(e,t,r,i){n.useProgram(r);n.viewport(0,0,e,t);n.bindFramebuffer(n.FRAMEBUFFER,this.input.buffer);n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,this.output.texture,0);n.drawArrays(n.TRIANGLES,0,6);this.swap()},resize:function resize(e,t,r,i){n.useProgram(r);n.viewport(0,0,e,t);this.input.resize(e,t);this.output.resize(e,t)}}}},{key:"createBuffer",value:function createBuffer(e,t,r){var i=this.gl;var a=this.BUFFER_COUNT;this.BUFFER_COUNT+=2;i.getExtension("OES_texture_float");var n=i.createTexture();i.activeTexture(i.TEXTURE0+a);i.bindTexture(i.TEXTURE_2D,n);i.texImage2D(i.TEXTURE_2D,0,i.RGBA,e,t,0,i.RGBA,i.FLOAT,null);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE);var s=i.createFramebuffer();return{index:a,texture:n,buffer:s,W:e,H:t,resize:function resize(e,t){i.bindFramebuffer(i.FRAMEBUFFER,s);var r=Math.min(e,this.W);var o=Math.min(t,this.H);var l=new Float32Array(r*o*4);i.readPixels(0,0,r,o,i.RGBA,i.FLOAT,l);i.bindFramebuffer(i.FRAMEBUFFER,null);var u=a+1;var h=i.createTexture();i.activeTexture(i.TEXTURE0+u);i.bindTexture(i.TEXTURE_2D,h);i.texImage2D(i.TEXTURE_2D,0,i.RGBA,e,t,0,i.RGBA,i.FLOAT,null);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE);i.texSubImage2D(i.TEXTURE_2D,0,0,0,r,o,i.RGBA,i.FLOAT,l);var f=i.createFramebuffer();i.bindFramebuffer(i.FRAMEBUFFER,null);i.deleteTexture(n);i.activeTexture(i.TEXTURE0+a);i.bindTexture(i.TEXTURE_2D,h);a=this.index=a;n=this.texture=h;s=this.buffer=f;this.W=e;this.H=t}}}},{key:"resizeSwappableBuffers",value:function resizeSwappableBuffers(){var e=this.gl;var t=e.canvas.width,r=e.canvas.height;e.viewport(0,0,t,r);for(var i in this.buffers){var a=this.buffers[i];a.bundle.resize(t,r,a.program,a.name)}e.useProgram(this.program)}},{key:"version",value:function version(){return"0.1.7"}}]);return GlslCanvas}();function loadAllGlslCanvas(){var e=document.getElementsByClassName("glslCanvas");if(e.length>0){window.glslCanvases=[];for(var t=0;t<e.length;t++){var r=new u(e[t]);r.isValid&&window.glslCanvases.push(r)}}}window.addEventListener("load",(function(){loadAllGlslCanvas()}));export{u as default};

